name: E2E Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run daily at 06:00 UTC
    - cron: "0 6 * * *"
  workflow_dispatch:

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Install Playwright browsers and system dependencies
        run: npx playwright install --with-deps chromium

      - name: Run E2E tests
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          chmod +x run-test.sh
          # Run tests; capture exit code but don't fail yet so we can parse the report
          set +e
          ./run-test.sh 2>&1 | tee test-output.log
          TEST_EXIT_CODE=${PIPESTATUS[0]}
          set -e

          echo ""
          echo "========================================="
          echo "  TEST RESULTS SUMMARY"
          echo "========================================="
          echo ""

          if [ -f report.html ]; then
            # Extract overall verdict
            VERDICT=$(grep -oP '(?<=Overall Verdict:</strong>\s)[\w]+' report.html || grep -oP '(PASS|FAIL|PARTIAL)' report.html | tail -1 || echo "UNKNOWN")
            echo "Overall Verdict: $VERDICT"
            echo ""

            # Extract test step results (PASS/FAIL lines from the summary table)
            echo "--- Step Results ---"
            # Extract table rows with status
            grep -oP '<td>[^<]*</td>' report.html | sed 's/<[^>]*>//g' | paste - - - - - 2>/dev/null | head -20 || true
            echo ""

            # Check for JavaScript errors
            if grep -q "No JavaScript errors detected" report.html; then
              echo "JavaScript Errors: None"
            else
              echo "--- JavaScript Errors ---"
              # Extract error text between the JS errors heading and the next section
              sed -n '/<h2.*JavaScript Errors/,/<h2/p' report.html | sed 's/<[^>]*>//g' | grep -v '^\s*$' | head -30 || echo "(see report.html for details)"
              echo ""
            fi

            # Check for visual bugs
            if grep -q "No visual bugs detected" report.html; then
              echo "Visual Bugs: None"
            else
              echo "--- Visual Bugs ---"
              sed -n '/<h2.*Visual Bugs/,/<h2/p' report.html | sed 's/<[^>]*>//g' | grep -v '^\s*$' | head -30 || echo "(see report.html for details)"
              echo ""
            fi

            # Check for FAIL in report
            FAIL_COUNT=$(grep -oi 'FAIL' report.html | wc -l || echo "0")
            if [ "$FAIL_COUNT" -gt 0 ]; then
              echo ""
              echo "WARNING: $FAIL_COUNT FAIL occurrence(s) found in report"
            fi
          else
            echo "ERROR: No report.html was generated!"
          fi

          echo ""
          echo "========================================="
          exit $TEST_EXIT_CODE

      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-report
          path: report.html
          retention-days: 30

      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-screenshots
          path: "*.png"
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload test log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-log
          path: test-output.log
          retention-days: 30
          if-no-files-found: ignore
